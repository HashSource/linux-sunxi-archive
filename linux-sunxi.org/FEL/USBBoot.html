
<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>FEL/USBBoot - linux-sunxi.org</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":!1,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"5ab0b2f281dc7a35909731d0","wgCSPNonce":!1,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":!1,"wgNamespaceNumber":0,"wgPageName":"FEL/USBBoot","wgTitle":"FEL/USBBoot","wgCurRevisionId":25215,"wgRevisionId":25215,"wgArticleId":219,"wgIsArticle":!0,"wgIsRedirect":!1,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Tutorial","Boot"],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":"FEL/USBBoot","wgRelevantArticleId":219,"wgIsProbablyEditable":!1,"wgRelevantPageIsProbablyEditable":!1,"wgRestrictionEdit":[],"wgRestrictionMove":[]};RLSTATE={"site.styles":"ready","noscript":"ready","user.styles":
"ready","user":"ready","user.options":"loading","ext.cite.styles":"ready","skins.vector.styles.legacy":"ready","jquery.makeCollapsible.styles":"ready","mediawiki.toc.styles":"ready"};RLPAGEMODULES=["ext.RegularTooltips","ext.cite.ux-enhancements","site","mediawiki.page.startup","mediawiki.page.ready","jquery.makeCollapsible","mediawiki.toc","skins.vector.legacy.js"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@1hzgi",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});
});});</script>
<link rel="stylesheet" href="https://linux-sunxi.org/load.php?lang=en&amp;modules=ext.cite.styles%7Cjquery.makeCollapsible.styles%7Cmediawiki.toc.styles%7Cskins.vector.styles.legacy&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://linux-sunxi.org/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://linux-sunxi.org/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.35.8"/>
<link rel="shortcut icon" href="https://linux-sunxi.org/favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="https://linux-sunxi.org/opensearch_desc.php" title="linux-sunxi.org (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="https://linux-sunxi.org/api.php?action=rsd"/>
<link rel="license" href="http://creativecommons.org/licenses/by/3.0/"/>
<link rel="alternate" type="application/atom+xml" title="linux-sunxi.org Atom feed" href="https://linux-sunxi.org/index.php?title=Special:RecentChanges&amp;feed=atom"/>
<link rel="canonical" href="USBBoot.html"/>
<!--[if lt IE 9]><script src="/resources/lib/html5shiv/html5shiv.js"></script><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-FEL_USBBoot rootpage-FEL skin-vector action-view skin-vector-legacy">
<div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">FEL/USBBoot</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From linux-sunxi.org</div>
		<div id="contentSub"><span class="subpages">&lt; <a href="../FEL" title="FEL">FEL</a></span></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><p>On <a href="USBBoot.html#SoC_support_status" title="FEL/USBBoot">supported Allwinner SoCs</a> it is possible to boot over USB OTG. This requires only minimal changes compared to the build steps in <a href="../Manual_build_howto.html" title="Manual build howto"> the manual build howto</a>, and these changes are explained on this wiki page.
</p><p>By booting over USB OTG, it is possible to forgo the SD-Card entirely, and it is especially useful for devices where no <a href="../UART.html" title="UART">UART</a> can be found, or where the UART is multiplexed with the SD-Card. You can then use <a href="../MicroSD_Breakout.html" title="MicroSD Breakout"> a micro-SD breakout adapter</a> to access the serial port.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Install_the_tools"><span class="tocnumber">1</span> <span class="toctext">Install the tools</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Switch_your_device_into_FEL_mode"><span class="tocnumber">2</span> <span class="toctext">Switch your device into FEL mode</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Boot_the_system_over_USB"><span class="tocnumber">3</span> <span class="toctext">Boot the system over USB</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Mainline_U-Boot_.28v2015.04_and_newer_versions.29"><span class="tocnumber">3.1</span> <span class="toctext">Mainline U-Boot (v2015.04 and newer versions)</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#Getting_the_mainline_U-Boot_sources"><span class="tocnumber">3.1.1</span> <span class="toctext">Getting the mainline U-Boot sources</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Booting_U-Boot_over_USB"><span class="tocnumber">3.1.2</span> <span class="toctext">Booting U-Boot over USB</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#Booting_the_whole_system_over_USB_.28U-Boot_.2B_kernel_.2B_initramfs.29"><span class="tocnumber">3.1.3</span> <span class="toctext">Booting the whole system over USB (U-Boot + kernel + initramfs)</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#Overriding_environment_variables_with_uEnv-style_data"><span class="tocnumber">3.1.4</span> <span class="toctext">Overriding environment variables with uEnv-style data</span></a>
<ul>
<li class="toclevel-4 tocsection-9"><a href="#Example"><span class="tocnumber">3.1.4.1</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-10"><a href="#Early_kernel_development_for_new_SoCs"><span class="tocnumber">3.1.5</span> <span class="toctext">Early kernel development for new SoCs</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-11"><a href="#Legacy_mainline_U-Boot_.28v2015.04_and_older_versions.29"><span class="tocnumber">3.2</span> <span class="toctext">Legacy mainline U-Boot (v2015.04 and older versions)</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Legacy_u-boot-sunxi"><span class="tocnumber">3.3</span> <span class="toctext">Legacy u-boot-sunxi</span></a>
<ul>
<li class="toclevel-3 tocsection-13"><a href="#Preparing_U-Boot"><span class="tocnumber">3.3.1</span> <span class="toctext">Preparing U-Boot</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="#Manual_loading"><span class="tocnumber">3.3.2</span> <span class="toctext">Manual loading</span></a></li>
<li class="toclevel-3 tocsection-15"><a href="#usb-boot_script"><span class="tocnumber">3.3.3</span> <span class="toctext">usb-boot script</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-16"><a href="#Using_sunxi-fel_on_Windows"><span class="tocnumber">3.4</span> <span class="toctext">Using sunxi-fel on Windows</span></a>
<ul>
<li class="toclevel-3 tocsection-17"><a href="#Mandatory_USB_driver"><span class="tocnumber">3.4.1</span> <span class="toctext">Mandatory USB driver</span></a></li>
<li class="toclevel-3 tocsection-18"><a href="#Zadig_to_the_rescue"><span class="tocnumber">3.4.2</span> <span class="toctext">Zadig to the rescue</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-19"><a href="#Adding_support_for_new_SoC_variants"><span class="tocnumber">4</span> <span class="toctext">Adding support for new SoC variants</span></a>
<ul>
<li class="toclevel-2 tocsection-20"><a href="#SoC_support_status"><span class="tocnumber">4.1</span> <span class="toctext">SoC support status</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="#General_description_of_the_.22sunxi-fel_uboot.22_command_implementation"><span class="tocnumber">4.2</span> <span class="toctext">General description of the "sunxi-fel uboot" command implementation</span></a></li>
<li class="toclevel-2 tocsection-22"><a href="#The_SoC-specific_mandatory_thing"><span class="tocnumber">4.3</span> <span class="toctext">The SoC-specific mandatory thing</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="#The_SoC-specific_bonus_features"><span class="tocnumber">4.4</span> <span class="toctext">The SoC-specific bonus features</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#Testing"><span class="tocnumber">4.5</span> <span class="toctext">Testing</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-25"><a href="#Potential_future_improvements"><span class="tocnumber">5</span> <span class="toctext">Potential future improvements</span></a></li>
<li class="toclevel-1 tocsection-26"><a href="#Known_issues"><span class="tocnumber">6</span> <span class="toctext">Known issues</span></a></li>
<li class="toclevel-1 tocsection-27"><a href="#See_also"><span class="tocnumber">7</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h1><span class="mw-headline" id="Install_the_tools">Install the tools</span></h1>
<p>There is a utility in <a href="../Sunxi-tools.html" title="Sunxi-tools"> the sunxi-tools repository</a> called 'sunxi-fel'. This utility is used for booting the system over USB and it needs to be installed first.
</p><p>The command line syntax of the <code>sunxi-fel</code> utility:
</p>
<pre>Usage: sunxi-fel [options] command arguments... [command...]
        -v, --verbose                   Verbose logging
        -p, --progress                  "write" transfers show a progress bar
        -l, --list                      Enumerate all (USB) FEL devices and exit
        -d, --dev bus:devnum            Use specific USB bus and device number
            --sid SID                   Select device by SID key (exact match)

        spl file                        Load and execute U-Boot SPL
                If file additionally contains a main U-Boot binary
                (u-boot-sunxi-with-spl.bin), this command also transfers that
                to memory (default address from image), but won't execute it.

        uboot file-with-spl             like "spl", but actually starts U-Boot
                U-Boot execution will take place when the fel utility exits.
                This allows combining "uboot" with further "write" commands
                (to transfer other files needed for the boot).

        hex[dump] address length        Dumps memory region in hex
        dump address length             Binary memory dump
        exe[cute] address               Call function address
        reset64 address                 RMR request for AArch64 warm boot
        memmove dest source size	Copy &lt;size&gt; bytes within device memory
        readl address                   Read 32-bit value from device memory
        writel address value            Write 32-bit value to device memory
        read address length file        Write memory contents into file
        write address file              Store file contents into memory
        write-with-progress addr file   "write" with progress bar
        write-with-gauge addr file      Output progress for "dialog --gauge"
        write-with-xgauge addr file     Extended gauge output (updates prompt)
        multi[write] # addr file ...    "write-with-progress" multiple files,
                                        sharing a common progress status
        multi[write]-with-gauge ...     like their "write-with-*" counterpart,
        multi[write]-with-xgauge ...      but following the 'multi' syntax:
                                          &lt;#&gt; addr file [addr file [...]]
        echo-gauge "some text"          Update prompt/caption for gauge output
        ver[sion]                       Show BROM version
        sid                             Retrieve and output 128-bit SID key
        clear address length            Clear memory
        fill address length value       Fill memory

	spiflash-info			Retrieves basic information
	spiflash-read addr length file	Write SPI flash contents into file
	spiflash-write addr file	Store file contents into SPI flash
</pre>
<p><a href="https://linux-sunxi.org/File:Exclamation.png" class="image"><img alt="Exclamation.png" src="https://linux-sunxi.org/images/c/c0/Exclamation.png" decoding="async" width="16" height="16" /></a> <i>Warning:</i> some Linux distributions are already providing packaging for sunxi-tools. However they are also removing certain tools and renaming executables at their discretion. If you encounter troubles with the sunxi-tools package from your distro, then getting sunxi-tools directly from the <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools">github repository</a> is always an option.
</p>
<h1><span class="mw-headline" id="Switch_your_device_into_FEL_mode">Switch your device into FEL mode</span></h1>
<p>Before the 'sunxi-fel' tool can actually talk to your device, the device needs to be connected to your PC using a "USB A to USB mini/micro B" cable.
</p><p>And then the device needs to be switched into FEL mode. Please refer to the <a href="../FEL" title="FEL"> FEL howto</a> for information on how to boot to FEL mode. Device pages should mention the button which triggers FEL mode as well.
</p><p>If you run:
</p>
<pre> sunxi-fel version </pre>
<p>and it returns something like:
</p>
<pre> AWUSBFEX soc=00162500(A13) 00000001 ver=0001 44 08 scratchpad=00007e00 00000000 00000000 </pre>
<p>Then you have successfully switched the device into FEL mode and it is ready to accept commands or load the system over USB.
</p>
<h1><span class="mw-headline" id="Boot_the_system_over_USB">Boot the system over USB</span></h1>
<h2><span id="Mainline_U-Boot_(v2015.04_and_newer_versions)"></span><span class="mw-headline" id="Mainline_U-Boot_.28v2015.04_and_newer_versions.29">Mainline U-Boot (v2015.04 and newer versions)</span></h2>
<h3><span class="mw-headline" id="Getting_the_mainline_U-Boot_sources">Getting the mainline U-Boot sources</span></h3>
<p>To obtain the U-Boot sources, clone the current U-Boot master branch:
</p>
<pre>git clone git://git.denx.de/u-boot.git
cd u-boot
</pre>
<p>Or alternatively the 'next' branch from the sunxi custodian tree:
</p>
<pre>git clone -b next git://git.denx.de/u-boot-sunxi.git
cd u-boot-sunxi
</pre>
<p>Both of these branches are bleeding edge and may contain bugs from time to time. If you encounter troubles, try a tarball with the latest formal U-Boot release before giving up.
</p>
<h3><span class="mw-headline" id="Booting_U-Boot_over_USB">Booting U-Boot over USB</span></h3>
<p>Then just do a regular u-boot build:
</p>
<pre>make CROSS_COMPILE=arm-linux-gnueabihf- Cubietruck_defconfig
make CROSS_COMPILE=arm-linux-gnueabihf- -j$(nproc)
</pre>
<p>For 64-bit SoCs:
</p>
<pre>make CROSS_COMPILE=aarch64-linux-gnu- &lt;your-board&gt;_defconfig
make CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) BL31=/path/to/trusted-firmware/build/sun50i-a64/debug/bl31.bin SCP=/dev/null
</pre>
<p>Make sure to pick the right Trusted-Firmware (TF-A, aka ATF) target, for A64 and H5 it's sun50i-a64, for H6 it's sun50i-h6, for H616/H313 it's sun50i-h616.
</p><p>And boot it over USB (the 'sunxi-fel uboot' command requires an up to date version of sunxi-tools):
</p>
<pre>sunxi-fel uboot u-boot-sunxi-with-spl.bin
</pre>
<p>This boots U-Boot over USB. And after U-Boot takes control, it starts scanning various default locations for the boot.scr file in order to boot the rest of the system.
</p>
<h3><span id="Booting_the_whole_system_over_USB_(U-Boot_+_kernel_+_initramfs)"></span><span class="mw-headline" id="Booting_the_whole_system_over_USB_.28U-Boot_.2B_kernel_.2B_initramfs.29">Booting the whole system over USB (U-Boot + kernel + initramfs)</span></h3>
<p>This needs to be used with <b>U-Boot v2015.10</b> or newer (which can automatically find the 'boot.scr' blob in RAM after it had been uploaded there by 'sunxi-fel').
</p><p>Assuming that you have a kernel image, a correct dtb blob for your hardware, a <a href="../Mainline_U-Boot.html#Install_U-Boot" class="mw-redirect" title="Mainline U-Boot">boot script blob</a> and an initrd image, booting all of this can be done with just a single 'sunxi-fel' invocation:
</p>
<pre>sunxi-fel -v uboot u-boot-sunxi-with-spl.bin \
             write 0x42000000 uImage \
             write 0x43000000 sun7i-a20-cubietruck.dtb \
             write 0x43100000 boot.scr \
             write 0x43300000 rootfs.cpio.lzma.uboot
</pre>
<p>For 64-bit SoCs:
</p>
<pre>sunxi-fel -v uboot u-boot-sunxi-with-spl.bin \
             write 0x40200000 Image \
             write 0x4fa00000 sun50i-a64-pine64-lts.dtb \
             write 0x4fc00000 boot.scr \
             write 0x4ff00000 rootfs.cpio.lzma.uboot
</pre>
<p>If you wonder about all the magic addresses used in the command line above, the right values can be found in the <a rel="nofollow" class="external text" href="http://git.denx.de/?p=u-boot.git;a=blob;f=include/configs/sunxi-common.h">U-Boot sources</a> in <tt>MEM_LAYOUT_ENV_SETTINGS</tt> definition (see #ifdef CONFIG_ARM64 for the 64-bit values):
</p>
<pre>bootm_size     = 0xf000000
kernel_addr_r  = 0x42000000
fdt_addr_r     = 0x43000000
scriptaddr     = 0x43100000
pxefile_addr_r = 0x43200000
ramdisk_addr_r = 0x43300000
</pre>
<p>Somewhere between U-Boot v2017.03 and v2017.07, U-Boot switched to a new SPL format, which is not compatible with sunxi-tools release &lt;=1.4.2 provided by some distros. The tool will print error message such as
</p>
<pre>sunxi SPL version mismatch: found 0x02 &gt; maximum supported 0x01.
You need a more recent version of this (sunxi-tools) fel utility.
</pre>
<p>You will need a later sunxi-tools from git to avoid this problem.
</p>
<table class="wikitable">
<tbody><tr>
<th colspan="2">an example boot.cmd
</th></tr>
<tr>
<td>32-bit boards
</td>
<td>64-bit boards
</td></tr>
<tr>
<td>
<pre>env set fdt_high ffffffff
bootm 0x42000000 0x43300000 0x43000000
</pre>
</td>
<td>
<pre>booti 0x40200000 0x4ff00000 0x4fa00000
</pre>
</td></tr></tbody></table>
<p>Following options may have to be enabled if you are using Buildroot (for 32-bit systems):
</p>
<pre>BR2_LINUX_KERNEL_UIMAGE=y
BR2_LINUX_KERNEL_UIMAGE_LOADADDR=0x42000000
BR2_TARGET_ROOTFS_CPIO=y
BR2_TARGET_ROOTFS_CPIO_LZMA=y
BR2_TARGET_ROOTFS_CPIO_UIMAGE=y
BR2_TARGET_ROOTFS_INITRAMFS=y
</pre>
<h3><span class="mw-headline" id="Overriding_environment_variables_with_uEnv-style_data">Overriding environment variables with uEnv-style data</span></h3>
<p>With v1.4 and above, the <tt>sunxi-fel</tt> utility has gained the ability to pass environment data to U-Boot via FEL.
</p><p><i>key=&lt;value&gt;</i> pairs from a textual representation will get <b>merged with the default environment</b>;
similar to U-Boot's <code>import -t</code> command, or what older U-Boot did with the <i>uEnv.txt</i> file on autoboot.
</p>
<dl><dd><a href="https://linux-sunxi.org/File:Sticky-note-pin.png" class="image"><img alt="Sticky-note-pin.png" src="https://linux-sunxi.org/images/f/f0/Sticky-note-pin.png" decoding="async" width="16" height="16" /></a> <i>Note:</i> <span style="color:#ba0000">This requires an up-to-date U-Boot (v2016.09 or later), plus you need to start your data with a special 'magic' signature:</span></dd>
<dd><pre>#=uEnv</pre></dd></dl>
<p>The signature will allow the sunxi-fel "write" command to detect uEnv-style data - and will cause it to flag this transfer accordingly, in turn requesting U-Boot v2016.09+ to import it afterwards. You may override arbitrary environment variables this way, including the <code>bootcmd</code>.
</p>
<h4><span class="mw-headline" id="Example">Example</span></h4>
<p>Use your text editor to save a <i>my.env</i> file with
</p>
<pre>#=uEnv
myvar=world
bootcmd=echo "Hello $myvar."
</pre>
<p>and then test it with
</p>
<pre>./sunxi-fel uboot u-boot-sunxi-with-spl.bin write 0x43100000 my.env</pre>
<p>You should see U-Boot's autoboot print the corresponding message and drop you to the prompt, proving that you have successfully overwritten the default "bootcmd".
</p>
<h3><span class="mw-headline" id="Early_kernel_development_for_new_SoCs">Early kernel development for new SoCs</span></h3>
<p>Because FEL boot is supported by the BROM code, it is readily available out of the box. The 'sunxi-fel' tool only needs to be patched to add the SRAM layout information, but this is <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools/commit/65bcc0501382db606ab5a5b5eb39f6f1c06b2df8">usually very simple</a> and also extensively documented on this wiki page. A relatively challenging task is the U-Boot support, because it needs the DRAM initialization code for the SPL. But assuming that the U-Boot bootloader is already available, FEL boot can be used for kernel development even when there is no Ethernet or MMC support in the kernel yet. For the sake of convenience, it is best to write <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools/blob/master/bin/fel-sdboot.sunxi">fel-sdboot.sunxi</a> to the SD card (substitute /dev/sdX with the appropriate block device of your card reader):
</p>
<pre>wget https://github.com/linux-sunxi/sunxi-tools/raw/master/bin/fel-sdboot.sunxi
dd if=fel-sdboot.sunxi of=/dev/sdX bs=1024 seek=8
</pre>
<p>Then just use the instructions from the previous section <a href="USBBoot.html#Booting_the_whole_system_over_USB_.28U-Boot_.2B_kernel_.2B_initramfs.29" title="FEL/USBBoot">about U-Boot + kernel + initramfs</a>. And after the MMC support is implemented in the kernel, it becomes possible to move the rootfs to the SD card and get rid of the initrd image. But FEL USB boot is still useful until either Ethernet or USB becomes good enough for booting over network.
</p>
<h2><span id="Legacy_mainline_U-Boot_(v2015.04_and_older_versions)"></span><span class="mw-headline" id="Legacy_mainline_U-Boot_.28v2015.04_and_older_versions.29">Legacy mainline U-Boot (v2015.04 and older versions)</span></h2>
<div class="mw-collapsible mw-collapsed">
<p><span style="color:red"><b>Is here for historical reference only (click on the 'Expand' link to see it):</b></span>
</p>
<div class="mw-collapsible-content">
<p>The U-Boot had to be configured using "*_<b>felconfig</b>" option before compiling (instead of "*_defconfig", as that builds a SPL only suitable for MMC boot). For example, in the case of a Cubietruck board, that would be:
</p>
<pre>make CROSS_COMPILE=arm-linux-gnueabihf- Cubietruck_felconfig
make CROSS_COMPILE=arm-linux-gnueabihf- -j$(nproc)
</pre>
<p>Then just use the 'sunxi-fel' tool to upload various pieces to certain magic addresses (the magic CONFIG_SPL_TEXT_BASE=0x2000 and CONFIG_SYS_TEXT_BASE=0x4a000000 values can be found in the <a rel="nofollow" class="external text" href="http://git.denx.de/?p=u-boot.git;a=blob;f=include/configs/sunxi-common.h;h=6cfd7e148900">U-Boot sources</a>). And execute them in a certain order:
</p>
<pre>echo == upload the SPL to SRAM and execute it ==
sunxi-fel write 0x2000 spl/u-boot-spl.bin
sunxi-fel exe   0x2000

sleep 1 # wait for DRAM initialization to complete

echo == upload the main u-boot binary to DRAM ==
sunxi-fel write 0x4a000000 u-boot.bin

echo == execute the main u-boot binary ==
sunxi-fel exe   0x4a000000
</pre>
<p>This boots U-Boot over USB. And after U-Boot takes control, it starts scanning various default locations for the boot.scr file in order to boot the rest of the system.
</p>
</div>
</div>
<h2><span class="mw-headline" id="Legacy_u-boot-sunxi">Legacy u-boot-sunxi</span></h2>
<div class="mw-collapsible mw-collapsed">
<p><span style="color:red"><b>Is here for historical reference only (click on the 'Expand' link to see it):</b></span>
</p>
<div class="mw-collapsible-content">
<h3><span class="mw-headline" id="Preparing_U-Boot">Preparing U-Boot</span></h3>
<p>U-boot needs to be built specifically for booting over USB. This is called FEL mode, and enabling this disables the full SD card (for u-boot, script.bin and the kernel might re-enable it later on).
</p><p>Just follow the <a href="../U-Boot.html#Compile_U-Boot" title="U-Boot"> guide to compile u-boot</a>, but <a href="../U-Boot.html#Determine_build_target" title="U-Boot"> select a target</a> whose name has <b>_FEL</b>.
</p>
<h3><span class="mw-headline" id="Manual_loading">Manual loading</span></h3>
<p>While the script from the next section is perhaps better, you can now choose to load u-boot manually:
</p>
<pre>  sunxi-fel write 0x2000 ../u-boot/spl/u-boot-spl.bin
  sunxi-fel exe 0x2000
  sleep 1 # Wait for DRAM initialization to complete
  sunxi-fel write 0x4a000000 ../u-boot/u-boot.bin
  sunxi-fel exe 0x4a000000
</pre>
<h3><span class="mw-headline" id="usb-boot_script">usb-boot script</span></h3>
<p>There was a script in the older releases of <a href="../Sunxi-tools.html" title="Sunxi-tools">Sunxi-tools</a> called <a href="../Sunxi-tools.html#usb-boot" title="Sunxi-tools"> usb-boot</a>. You can download this script from github using the tag for an old version 1.2:
</p>
<pre>wget https://raw.githubusercontent.com/linux-sunxi/sunxi-tools/v1.2/usb-boot
chmod +x usb-boot
</pre>
<p>And then use it as follows:
</p>
<pre>Usage: ./usb-boot u-boot-spl.bin u-boot.bin [boot.scr] [kernel script.bin [initramfs]]</pre>
<p>u-boot-spl.bin and u-boot.bin are the <a href="../U-Boot.html" title="U-Boot">u-boot binaries</a> which are <a href="USBBoot.html#Preparing_U-Boot" title="FEL/USBBoot"> FEL enabled</a>.
</p><p><a href="../Manual_build_howto.html#boot.cmd" title="Manual build howto"> boot.scr</a> is the u-boot script. If you do not specify a file ending with .scr the default is used.
</p><p>uImage is your <a href="../Linux_Kernel.html#Compilation" title="Linux Kernel"> compiled kernel image</a>.
</p><p><a href="../Manual_build_howto.html#Building_script.bin" title="Manual build howto"> script.bin</a> is your hw configuration converted to binary from .fex.
</p><p>initramfs is an optional initramfs/initrd image in u-boot mkimage format.
</p>
</div>
</div>
<h2><span class="mw-headline" id="Using_sunxi-fel_on_Windows">Using sunxi-fel on Windows</span></h2>
<ul><li><a class="external free" href="https://github.com/linux-sunxi/sunxi-tools/tree/windows#using-sunxi-tools-under-windows#using-sunxi-tools-under-windows">https://github.com/linux-sunxi/sunxi-tools/tree/windows#using-sunxi-tools-under-windows</a></li>
<li>Pre-built mingw32-w64 <a class="external text" href="https://github.com/eperie/build-scripts/releases/download/v1.3/sunxi-tools-mingw64-530adfa.zip">binaries</a> - built from revision 530adfa1420c1a1a73aa93df5b4d4c39f997f490 of <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools">sunxi-tools</a>.</li></ul>
<h3><span class="mw-headline" id="Mandatory_USB_driver">Mandatory USB driver</span></h3>
<p>Under Windows (unlike Linux) every USB device that an application program wishes to access <b>must have a suitable USB driver installed</b>.
</p><p>This means that <i>any device that shows up as "unknown" in your Device Manager will be <span style="color:#ba0000">inaccessible</span></i> - typical symptoms would be an <tt>ERROR: Allwinner USB FEL device not found!</tt> message, or even
</p>
<pre>libusb_open() ERROR -12: Operation not supported or unimplemented on this platform</pre>
<p>when trying to enforce the specific device with the <code>--dev</code> option.
</p>
<h3><span class="mw-headline" id="Zadig_to_the_rescue">Zadig to the rescue</span></h3>
<p>Fortunately, there's a very convenient utility to help with the USB driver setup. Grab your copy from <a rel="nofollow" class="external free" href="http://zadig.akeo.ie/">http://zadig.akeo.ie/</a>.
</p><p>Before launching it, make sure your Allwinner device is connected and in <a href="../FEL" title="FEL">FEL</a> mode.
</p><p><a href="https://linux-sunxi.org/File:Zadig-fel-winusb-instructions.png" class="image"><img alt="Zadig-fel-winusb-instructions.png" src="https://linux-sunxi.org/images/7/7a/Zadig-fel-winusb-instructions.png" decoding="async" width="575" height="249" /></a>
</p><p><br />Initially, the Zadig utility should only present you a single "Unknown Device #1". If it happens to actually list multiple devices, make sure you pick the correct one by verifying the <b>USB ID</b>, shown as "<b>1F3A:EFE8</b>" in above picture.
</p>
<ol><li><i>(Optional, but recommended)</i> Tick the "Edit" checkbox on the right hand side, and enter a more descriptive name for the USB ID in question. This helps a lot later, to distinguish your Allwinner device from other USB entries in the Device Manager.</li>
<li>Select the desired USB driver. This depends on the Windows executables you intend to use; namely the specific version of <i>libusb</i> that those binaries were compiled with. If your <tt>sunxi-fel.exe</tt> has special driver requirements, those should be stated in the accompanying documentation. When in doubt, select <a rel="nofollow" class="external text" href="http://windows.libusb.info/"><b>WinUSB</b></a> for a "generic" driver (available from Win XP SP3 onwards).</li>
<li>Click "Install Driver". Voilà - from now on your device should no longer be "unknown" in Device Manager, and <tt>sunxi-fel</tt> is expected to work with it.</li></ol>
<dl><dd><a href="https://linux-sunxi.org/File:Sunxi-fel_win32.png" class="image"><img alt="Sunxi-fel win32.png" src="https://linux-sunxi.org/images/thumb/a/ab/Sunxi-fel_win32.png/500px-Sunxi-fel_win32.png" decoding="async" width="500" height="294" srcset="https://linux-sunxi.org/images/thumb/a/ab/Sunxi-fel_win32.png/750px-Sunxi-fel_win32.png 1.5x, https://linux-sunxi.org/images/a/ab/Sunxi-fel_win32.png 2x" /></a></dd></dl>
<p><br /><b>Troubleshooting:</b>
</p>
<ul><li>If you have <tt>listdevs.exe</tt> available in your package, you may use it to check that Windows detects your device at all, and to determine the <i>libusb</i> bus/device numbers.</li>
<li>In case you selected the wrong driver, you may simply re-run Zadig to install another. Use "<i>Options</i>", "<i>List All Devices</i>" and pick the desired one (keeping an eye on the USB ID once more). Alternatively you can use the Windows Device Manager to remove/uninstall the driver (effectively rendering the device "unknown" again), and then start from scratch.</li></ul>
<hr />
<h1><span class="mw-headline" id="Adding_support_for_new_SoC_variants">Adding support for new SoC variants</span></h1>
<p>If everything is already working fine for you, then you can stop reading here&#160;:-) But sometimes you may get messages like <b>"SPL: Unsupported SoC type"</b> or <b>"Warning: no 'soc_sram_info' data for your SoC"</b> when trying to use the instructions from the previous sections. In this case, doing some work to add support for your SoC may be required. It is also a good idea to first check the <a href="USBBoot.html#SoC_support_status" title="FEL/USBBoot">SoC support status</a> table below.
</p>
<h2><span class="mw-headline" id="SoC_support_status">SoC support status</span></h2>
<table class="wikitable">
<tbody><tr>
<th>SoC name
</th>
<th>SoC support status in sunxi-tools <sup id="cite_ref-uboot_1-0" class="reference"><a href="#cite_note-uboot-1">&#91;1&#93;</a></sup>
</th>
<th>SoC support status in U-Boot
</th>
<th>"sunxi-fel write" speed <sup id="cite_ref-speed_2-0" class="reference"><a href="#cite_note-speed-2">&#91;2&#93;</a></sup>
</th>
<th>USB DFU speed
</th>
<th>MMU setup
</th>
<th>Stack pointers <sup id="cite_ref-stack_3-0" class="reference"><a href="#cite_note-stack-3">&#91;3&#93;</a></sup>
</th>
<th>Notes
</th></tr>
<tr>
<td>Allwinner <a href="../A10" title="A10">A10</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~600 KB/s</td>
<td>~3.2 MB/s</td>
<td>Enabled by BROM, ttbr0=0x20000</td>
<td>sp_irq=0x02000, sp=0x05DF8</td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../A13" title="A13">A13</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~570 KB/s (win7 laptop), ~940kB/s (linux opipc)</td>
<td></td>
<td>Enabled by BROM, ttbr0=0x08000</td>
<td>sp_irq=0x02000, sp=0x05DF8</td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../A20" title="A20">A20</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~960 KB/s</td>
<td>~3.7 MB/s</td>
<td>Enabled by BROM, ttbr0=0x20000</td>
<td>sp_irq=0x02000, sp=0x05E08</td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../A23.html" title="A23">A23</a></td>
<td>Supported</td>
<td>Supported</td>
<td></td>
<td></td>
<td>Enabled by BROM, ttbr0=0x08000</td>
<td></td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../A31s.html" class="mw-redirect" title="A31s">A31s</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~510 KB/s</td>
<td></td>
<td>Enabled by BROM, ttbr0=0x20000</td>
<td>sp_irq=0x02000, sp=0x05E08</td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../A33.html" title="A33">A33</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~191 KB/s</td>
<td></td>
<td>Not enabled by BROM</td>
<td></td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../A64" title="A64">A64</a></td>
<td>Supported</td>
<td>Supported <sup id="cite_ref-spl32_4-0" class="reference"><a href="#cite_note-spl32-4">&#91;4&#93;</a></sup></td>
<td>~510 KB/s</td>
<td></td>
<td>Not needed <sup id="cite_ref-goodspeed_5-0" class="reference"><a href="#cite_note-goodspeed-5">&#91;5&#93;</a></sup></td>
<td>sp_irq=0x12000, sp=0x15E08</td>
<td>SPL needs to be loaded at 0x10000 (instead of 0x0)
</td></tr>
<tr>
<td>Allwinner <a href="../A80" title="A80">A80</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~930 KB/s (boot0)</td>
<td></td>
<td>Not enabled by BROM</td>
<td>sp_irq=0x12000, sp=0x15AD0</td>
<td>SPL needs to be loaded at 0x10000 (instead of 0x0)
</td></tr>
<tr>
<td>Allwinner <a href="../A83T.html" title="A83T">A83T</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~510 KB/s (~191 KB/s if MMU not enabled)</td>
<td></td>
<td>Enabled by sunxi-fel, ttbr0=0x44000</td>
<td>sp_irq=0x00002000, sp=0x00005E08</td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../H3" title="H3">H3</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~960 KB/s</td>
<td></td>
<td>Enabled by sunxi-fel, ttbr0=0x44000</td>
<td>sp_irq=0x00002000, sp=0x00005E08</td>
<td>
</td></tr>
<tr>
<td>Allwinner <a href="../H5.html" title="H5">H5</a></td>
<td>Supported</td>
<td>Supported <sup id="cite_ref-spl32_4-1" class="reference"><a href="#cite_note-spl32-4">&#91;4&#93;</a></sup></td>
<td>?</td>
<td></td>
<td>?</td>
<td>sp_irq=0x12000, sp=0x15E08</td>
<td>SPL needs to be loaded at 0x10000
</td></tr>
<tr>
<td>Allwinner <a href="../H6.html" title="H6">H6</a></td>
<td>Supported</td>
<td>Supported <sup id="cite_ref-spl32_4-2" class="reference"><a href="#cite_note-spl32-4">&#91;4&#93;</a></sup></td>
<td>~177 KB/s</td>
<td></td>
<td>Not enabled by BROM</td>
<td>sp_irq=0x22000, sp=0x25E08</td>
<td>SPL needs to be loaded at 0x20000
</td></tr>
<tr>
<td>Allwinner <a href="../R8.html" class="mw-redirect" title="R8">R8</a></td>
<td>Supported</td>
<td>Supported</td>
<td>~500 KB/s</td>
<td></td>
<td>Enabled by BROM, ttbr0=0x08000</td>
<td>sp_irq=0x02000, sp=0x05DF8</td>
<td>basically like A13,<br />handled by same <i>soc_id</i>
</td></tr>
<tr>
<td>Allwinner <a href="../R40.html" title="R40">R40</a></td>
<td>Supported</td>
<td>Supported</td>
<td>?</td>
<td></td>
<td>Not enabled by BROM</td>
<td>sp_irq=0x02000, sp=0x05E08</td>
<td>
</td></tr></tbody></table>
<div class="mw-references-wrap"><ol class="references">
<li id="cite_note-uboot-1"><span class="mw-cite-backlink"><a href="#cite_ref-uboot_1-0">↑</a></span> <span class="reference-text">
Basic FEL commands like "read", "write" and "exe" are already supported in a generic way on every SoC. This table column only shows support status for advanced commands like "spl" and "uboot".</span>
</li>
<li id="cite_note-speed-2"><span class="mw-cite-backlink"><a href="#cite_ref-speed_2-0">↑</a></span> <span class="reference-text">
The transfer speed can be measured by running the following commands:
<pre># Execute only the SPL part of the U-Boot image in order to initialize DRAM
sunxi-fel spl u-boot-sunxi-with-spl.bin

# Upload a file to DRAM ('-p' enables a progress display, which includes transfer speed)
sunxi-fel -p write 0x42000000 uImage
</pre>
<p>You can use any file instead of "uImage". Larger file size means better speed measurement accuracy, so pick something that has size of at least several megabytes. Please note that the devices, which have MMU disabled, are currently expected to show slow transfer speeds (this can be probably improved later).
</p>
</span></li>
<li id="cite_note-stack-3"><span class="mw-cite-backlink"><a href="#cite_ref-stack_3-0">↑</a></span> <span class="reference-text">
There are two stacks in FEL mode:
<ul><li>'sp_irq' is the value of the IRQ stack pointer register. The IRQ stack is typically empty, which means that the 'sp_irq' is pointing to both top and bottom of this stack (unless the processor is currently handling an IRQ).</li>
<li>'sp' is the value of the normal stack pointer register, also available to your code when it is executed via "sunxi-fel exe" command. This stack typically contains quite a bit of data between 'sp' and 0x7000 (which was written there by the FEL code from BROM).</li></ul>
When uploading data via "sunxi-fel write" command, be sure not to overwrite these stacks (don't touch the data in SRAM below 'sp_irq' and above 'sp').</span>
</li>
<li id="cite_note-spl32-4"><span class="mw-cite-backlink">↑ <sup><a href="#cite_ref-spl32_4-0">4.0</a></sup> <sup><a href="#cite_ref-spl32_4-1">4.1</a></sup> <sup><a href="#cite_ref-spl32_4-2">4.2</a></sup></span> <span class="reference-text">Requires a 32-bit SPL build. There is a not-mainline(able) <a class="external text" href="https://github.com/apritzel/u-boot/commits/sunxi64-fel32">sunxi64-fel32</a> branch for that, also pre-built <a class="external text" href="https://github.com/apritzel/pine64/tree/master/binaries">binaries</a> for easy use with sunxi-fel.</span>
</li>
<li id="cite_note-goodspeed-5"><span class="mw-cite-backlink"><a href="#cite_ref-goodspeed_5-0">↑</a></span> <span class="reference-text">The BROM in A64 is not <a class="external text" href="https://github.com/ssvb/sunxi-tools/commit/b4116008efe28016ca85de83a7e1d453a1d7e745">troublesome</a> anymore and "sunxi-fel hexdump 0x1c14200 16" works fine for retrieving SID. This indicates somewhat better implementation and the MMU speed boosting workaround is not needed.</span>
</li>
</ol></div>
<h2><span id="General_description_of_the_&quot;sunxi-fel_uboot&quot;_command_implementation"></span><span class="mw-headline" id="General_description_of_the_.22sunxi-fel_uboot.22_command_implementation">General description of the "sunxi-fel uboot" command implementation</span></h2>
<p>Allwinner is treating booting over USB in a special way, and this behaviour is unfortunately hardcoded in the <a href="../BROM.html" title="BROM">BROM</a>. The main differences between booting from MMC/NAND and booting from USB are:
</p>
<ul><li>For booting from the SD card or NAND, the BROM code is searching for a special eGON signature on a bootable media and loading up to 32K (in fact a bit less than that) of the initial code to the address 0x0 in SRAM (that's typically the SRAM section A1) and then executes it. This initial code (known as "SPL" in U-Boot or "boot0" in the Allwinner's bootloader) configures the DRAM to get access to more storage space, then loads the main part of the bootloader and the rest of the system there.</li>
<li>For booting via FEL, the Allwinner's idea is that we are supposed to upload only something like up to ~15K of code at the address 0x2000 in SRAM and execute it.</li></ul>
<p>This is at least inconsistent and definitely not good for us. U-Boot used to require a special size-optimized variant of the SPL specifically for booting via FEL, which also had the base address changed from 0x0 to 0x2000 as an additional inconvenience. Having a special variant of the SPL means an extra configuration to maintain. And the code size limitation is also a nasty problem because a certain set of features has to be disabled. But the "spl" and "uboot" commands, which are implemented by the "sunxi-fel" tool, can work-around this limitation by smuggling just the ordinary MMC or NAND variant of the U-Boot SPL into SRAM. More technical details are provided below.
</p><p>The reason why we have ~15K code size limitation when booting via FEL is illustrated on the picture below. When we are booting the device in FEL mode, a special code is activated in the BROM and starts communicating over USB using FEL protocol. The USB driver code from the BROM allocates two stacks at rather inconvenient locations inside of the first 32K of SRAM. The IRQ handler stack is set at the address 0x2000 and grows down. And the ordinary application stack is set at the address 0x7000 and also grows down. These stacks make the SRAM space fragmented, and the largest usable contiguous ~15K area is sandwiched between these two stacks. Overwriting either of these stacks via the "sunxi-fel write" crashes the device and it just stops responding to further FEL commands. So uploading a normal U-Boot SPL (which typically has size slightly larger than 20K) to the address 0x0 via "sunxi-fel write" command with the intention to execute it via "sunxi-fel exe" command does not work as expected.
</p><p><a href="https://linux-sunxi.org/File:FEL_uboot_memory_map.jpg" class="image"><img alt="FEL uboot memory map.jpg" src="https://linux-sunxi.org/images/5/59/FEL_uboot_memory_map.jpg" decoding="async" width="1024" height="732" /></a>
</p><p>So, how do we solve this problem? Allwinner devices typically have more than 32K of SRAM (the smallest total amount of SRAM among all devices is 48K in Allwinner A13). And we can use extra SRAM locations as a backup storage for the FEL stacks (shown as "backup area 1" and "backup area 2" on the picture above). We also upload a special <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools/blob/1627b13718bae612a2cb14bb03de5bfd578280be/fel-to-spl-thunk.S">thunk code</a>, which is responsible for swapping the content of the FEL stacks with the content of these backup areas before jumping to the address 0x0. Now in order to execute a full-fledged SPL from U-Boot, we only need to split the SPL into chunks and upload it to SRAM, writing the parts which are supposed to overlap the FEL stacks to the backup areas. Executing the thunk code saves the FEL stacks to the backup areas, reassembles the SPL together and passes control to the SPL.
</p><p>Why do we need to backup the original FEL stacks? The reason is that just uploading and executing the SPL alone is not enough to boot the system. The SPL code is very small and its primary task is to setup clocks and initialize the DRAM. After the DRAM is initialized, all the storage space problems are resolved and we want to load the main U-Boot code to the device. And for this we still need the BROM FEL code alive and getting control back, so that it can still talk with the 'sunxi-fel' tool over USB and execute FEL commands. Hence the SPL returns control back to the thunk code. The thunk code swaps FEL stacks with backup areas again and finally passes control back to the FEL code in the BROM, which is able to happily resume its work because it has all the original data back in its stacks.
</p>
<h2><span class="mw-headline" id="The_SoC-specific_mandatory_thing">The SoC-specific mandatory thing</span></h2>
<p>The previous section describes how the "sunxi-fel spl" and "sunxi-fel uboot" commands work. But not everything is perfect. One inconvenient thing is that the SRAM address space layout (and the location of the backup areas) may be different for different SoC variants. Hence we need to provide the <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools/blob/01f9972842085f6dea59c64fca39f0107678af4a/fel.c#L325#L325">SRAM layout description information</a> for each SoC in the source code of the 'sunxi-fel' program. The comments in the source code should provide reasonable explanations. And here is an example of such SRAM layout information for A31:
</p>
<pre>/*
 * A31 is very similar to A10/A13/A20, except that it has no SRAM at 0x8000.
 * So we use the SRAM section at 0x44000 instead. This is the memory, which
 * is normally shared with the OpenRISC core (should we do an extra check to
 * ensure that this core is powered off and can't interfere?).
 */
sram_swap_buffers a31_sram_swap_buffers[] = {
	{ .buf1 = 0x01800, .buf2 = 0x44000, .size = 0x800 },
	{ .buf1 = 0x05C00, .buf2 = 0x44800, .size = 0x8000 - 0x5C00 },
	{ 0 }  /* End of the table */
};

soc_sram_info soc_sram_info_table[] = {
	{
		.soc_id       = 0x1633, /* Allwinner A31 */
		.thunk_addr   = 0x46E00, .thunk_size = 0x200,
		.swap_buffers = a31_sram_swap_buffers,
	},
	{ 0 } /* End of the table */
};
</pre>
<p>Basically, the first backup area for A31 is set at 0x44000 and covers the IRQ stack (0x1800-0x2000). The second backup area is set at 0x44800 and covers the normal FEL stack plus also some extra area above it (0x5C00-0x8000). The thunk code is placed at 0x46E00.
</p>
<h2><span class="mw-headline" id="The_SoC-specific_bonus_features">The SoC-specific bonus features</span></h2>
<ul><li>While this is not strictly required, we can <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools/commit/e4b3da2b17ee9d7c5cab9b80e708b3a309fc4c96">tweak the cacheability attributes of the memory sections by modifying the MMU translation table</a>. This improves the performance of the "sunxi-fel write" command and helps to significantly reduce the time needed to upload large chunks of data to DRAM.</li></ul>
<ul><li>The Cortex-A8 based SoC variants need <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools/commit/f6a1382b4a2337f34ff5c52b83c3666c2f57247d">a tweak for the AUXCR L2EN bit</a>. Without this, the L2 cache ends up disabled in Linux after booting over FEL.</li></ul>
<h2><span class="mw-headline" id="Testing">Testing</span></h2>
<p>After adding the support for a new SoC variant to the 'sunxi-fel' tool, it makes sense to actually test whether it works. In the case if U-Boot already has support for this particular SoC variant, the testing is simple and can be done by just running <b>"sunxi-fel uboot u-boot-sunxi-with-spl.bin"</b> command and confirming that U-Boot starts properly on the device.
</p><p>In the case if U-Boot still does not have full support for this particular SoC variant yet, testing still can be done using the Allwinner's boot0 bootloader. If you have some boot0-based bootable SD card image (let's call it 'sdcard-image.bin'), then you can:
</p>
<ul><li>write this image to an SD card</li>
<li>extract the boot0 part from this image via running <b>"dd if=sdcard-image.bin of=boot0.bin bs=1024 skip=8 count=32"</b></li>
<li>switch the device into FEL mode</li>
<li>insert the SD card</li>
<li>run <b>"sunxi-fel spl boot0.bin"</b></li></ul>
<p>If the system boots normally, in the same way as just doing a normal boot from the SD card, then the 'sunxi-fel' tool is working fine. Please note that you may get error messages from the 'sunxi-fel' tool while doing this. This is normal and expected (boot0 does not return control back to the FEL code in BROM but instead does its usual booting of the system from the SD card).
</p><p><br />
</p>
<h1><span class="mw-headline" id="Potential_future_improvements">Potential future improvements</span></h1>
<p>There is quite a lot of room for improvement:
</p>
<ul><li>Allow the 'sunxi-fel spl' command to also use raw SD card images in addition to just recognizing 'u-boot-sunxi-with-spl.bin' format.</li>
<li>Store the magic addresses (CONFIG_SYS_TEXT_BASE, kernel_addr_r, fdt_addr_r, scriptaddr, ramdisk_addr_r) in the <a href="../EGON.html" title="EGON">EGON</a> header extension in order to avoid the need of passing them to the 'sunxi-fel' tool as command line parameters.</li>
<li>Single U-Boot binary for both the regular UART serial console and the UART over the <a href="../MicroSD_Breakout.html" title="MicroSD Breakout">MicroSD Breakout</a> configurations. The configuration option can be provided to the 'sunxi-fel' tool in a command line argument and handed over to to U-Boot in the eGON header extension.</li></ul>
<p>The exact eGON header extension format needs to be formalized. We should also check whether it can provide backwards/forward compatibility with the Allwinner's BOOT0 bootloader.
</p>
<h1><span class="mw-headline" id="Known_issues">Known issues</span></h1>
<p>Please report problems to <a class="external free" href="https://github.com/linux-sunxi/sunxi-tools/issues">https://github.com/linux-sunxi/sunxi-tools/issues</a>
</p>
<h1><span class="mw-headline" id="See_also">See also</span></h1>
<ul><li><a href="../FEL" title="FEL">FEL</a></li>
<li><a href="../Miniroot.html" title="Miniroot">miniroot</a></li></ul>
<!-- 
NewPP limit report
Cached time: 20251029181026
Cache expiry: 86400
Dynamic content: false
Complications: []
CPU time usage: 0.106 seconds
Real time usage: 0.122 seconds
Preprocessor visited node count: 347/1000000
Post‐expand include size: 802/2097152 bytes
Template argument size: 655/2097152 bytes
Highest expansion depth: 5/40
Expensive parser function count: 0/100
Unstrip recursion depth: 1/20
Unstrip post‐expand size: 10241/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    8.699      1 -total
 54.09%    4.705      1 Template:Note
 31.07%    2.703      1 Template:Warn
 28.42%    2.472      2 Template:Red
-->

<!-- Saved in parser cache with key wiki:pcache:idhash:219-0!canonical and timestamp 20251029181026 and revision id 25215
 -->
</div></div><div class="printfooter">Retrieved from "<a dir="ltr" href="https://linux-sunxi.org/index.php?title=FEL/USBBoot&amp;oldid=25215">https://linux-sunxi.org/index.php?title=FEL/USBBoot&amp;oldid=25215</a>"</div>
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="https://linux-sunxi.org/Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="https://linux-sunxi.org/Category:Tutorial" title="Category:Tutorial">Tutorial</a></li><li><a href="https://linux-sunxi.org/Category:Boot" title="Category:Boot">Boot</a></li></ul></div></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-personal" class="vector-menu" aria-labelledby="p-personal-label" role="navigation" 
	 >
	<h3 id="p-personal-label">
		<span>Personal tools</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="pt-createaccount"><a href="https://linux-sunxi.org/index.php?title=Special:CreateAccount&amp;returnto=FEL%2FUSBBoot" title="You are encouraged to create an account and log in; however, it is not mandatory">Create account</a></li><li id="pt-login"><a href="https://linux-sunxi.org/index.php?title=Special:UserLogin&amp;returnto=FEL%2FUSBBoot" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li></ul>
		
	</div>
</nav>


		<div id="left-navigation">
			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-namespaces" class="vector-menu vector-menu-tabs vectorTabs" aria-labelledby="p-namespaces-label" role="navigation" 
	 >
	<h3 id="p-namespaces-label">
		<span>Namespaces</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected"><a href="USBBoot.html" title="View the content page [c]" accesskey="c">Page</a></li><li id="ca-talk" class="new"><a href="https://linux-sunxi.org/index.php?title=Talk:FEL/USBBoot&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t">Discussion</a></li></ul>
		
	</div>
</nav>


			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-variants" class="vector-menu-empty emptyPortlet vector-menu vector-menu-dropdown vectorMenu" aria-labelledby="p-variants-label" role="navigation" 
	 >
	<input type="checkbox" class="vector-menu-checkbox vectorMenuCheckbox" aria-labelledby="p-variants-label" />
	<h3 id="p-variants-label">
		<span>Variants</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="menu vector-menu-content-list"></ul>
		
	</div>
</nav>


		</div>
		<div id="right-navigation">
			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-views" class="vector-menu vector-menu-tabs vectorTabs" aria-labelledby="p-views-label" role="navigation" 
	 >
	<h3 id="p-views-label">
		<span>Views</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="ca-view" class="collapsible selected"><a href="USBBoot.html">Read</a></li><li id="ca-viewsource" class="collapsible"><a href="https://linux-sunxi.org/index.php?title=FEL/USBBoot&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li><li id="ca-history" class="collapsible"><a href="https://linux-sunxi.org/index.php?title=FEL/USBBoot&amp;action=history" title="Past revisions of this page [h]" accesskey="h">View history</a></li></ul>
		
	</div>
</nav>


			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-cactions" class="vector-menu-empty emptyPortlet vector-menu vector-menu-dropdown vectorMenu" aria-labelledby="p-cactions-label" role="navigation" 
	 >
	<input type="checkbox" class="vector-menu-checkbox vectorMenuCheckbox" aria-labelledby="p-cactions-label" />
	<h3 id="p-cactions-label">
		<span>More</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="menu vector-menu-content-list"></ul>
		
	</div>
</nav>


			<div id="p-search" role="search">
	<h3 >
		<label for="searchInput">Search</label>
	</h3>
	<form action="https://linux-sunxi.org/index.php" id="searchform">
		<div id="simpleSearch">
			<input type="search" name="search" placeholder="Search linux-sunxi.org" title="Search linux-sunxi.org [f]" accesskey="f" id="searchInput"/>
			<input type="hidden" name="title" value="Special:Search">
			<input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton"/>
			<input type="submit" name="go" value="Go" title="Go to a page with this exact name if it exists" id="searchButton" class="searchButton"/>
		</div>
	</form>
</div>

		</div>
	</div>
	
<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a  title="Visit the main page" class="mw-wiki-logo" href="../Main_Page.html"></a>
	</div>
	<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-navigation" class="vector-menu vector-menu-portal portal portal-first" aria-labelledby="p-navigation-label" role="navigation" 
	 >
	<h3 id="p-navigation-label">
		<span>Navigation</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="n-mainpage-description"><a href="../Main_Page.html" title="Visit the main page [z]" accesskey="z">Main page</a></li><li id="n-portal"><a href="../sunxi:Community_portal.html" title="About the project, what you can do, where to find things">Community portal</a></li><li id="n-recentchanges"><a href="https://linux-sunxi.org/Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li><li id="n-randompage"><a href="https://linux-sunxi.org/Special:Random" title="Load a random page [x]" accesskey="x">Random page</a></li><li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" rel="nofollow" title="The place to find out">Help</a></li></ul>
		
	</div>
</nav>


	<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-tb" class="vector-menu vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation" 
	 >
	<h3 id="p-tb-label">
		<span>Tools</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere"><a href="https://linux-sunxi.org/Special:WhatLinksHere/FEL/USBBoot" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="https://linux-sunxi.org/Special:RecentChangesLinked/FEL/USBBoot" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li><li id="t-specialpages"><a href="https://linux-sunxi.org/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="javascript:print();" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="https://linux-sunxi.org/index.php?title=FEL/USBBoot&amp;oldid=25215" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="https://linux-sunxi.org/index.php?title=FEL/USBBoot&amp;action=info" title="More information about this page">Page information</a></li></ul>
		
	</div>
</nav>


	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo" >
	<ul id="footer-info" >
		<li id="footer-info-lastmod"> This page was last edited on 30 December 2022, at 17:41.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution</a> unless otherwise noted.</li>
	</ul>
	<ul id="footer-places" >
		<li id="footer-places-privacy"><a href="https://linux-sunxi.org/sunxi:Privacy_policy" title="sunxi:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="https://linux-sunxi.org/sunxi:About" title="sunxi:About">About linux-sunxi.org</a></li>
		<li id="footer-places-disclaimer"><a href="https://linux-sunxi.org/sunxi:General_disclaimer" title="sunxi:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico"><a href="http://creativecommons.org/licenses/by/3.0/"><img src="https://linux-sunxi.org/resources/assets/licenses/cc-by.png" alt="Creative Commons Attribution" width="88" height="31" loading="lazy"/></a></li>
		<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="https://linux-sunxi.org/resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="https://linux-sunxi.org/resources/assets/poweredby_mediawiki_132x47.png 1.5x, https://linux-sunxi.org/resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"/></a></li>
	</ul>
	<div style="clear: both;"></div>
</footer>



<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.106","walltime":"0.122","ppvisitednodes":{"value":347,"limit":1000000},"postexpandincludesize":{"value":802,"limit":2097152},"templateargumentsize":{"value":655,"limit":2097152},"expansiondepth":{"value":5,"limit":40},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":1,"limit":20},"unstrip-size":{"value":10241,"limit":5000000},"timingprofile":["100.00%    8.699      1 -total"," 54.09%    4.705      1 Template:Note"," 31.07%    2.703      1 Template:Warn"," 28.42%    2.472      2 Template:Red"]},"cachereport":{"timestamp":"20251029181026","ttl":86400,"transientcontent":false}}});});</script>
<!-- No web analytics configured. -->

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":176});});</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"016cbc9bb6a94e94934580b61e921a02","server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body></html>
