
<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>TOC0 - linux-sunxi.org</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":!1,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"14fa378e4435c066a4321fbc","wgCSPNonce":!1,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":!1,"wgNamespaceNumber":0,"wgPageName":"TOC0","wgTitle":"TOC0","wgCurRevisionId":26064,"wgRevisionId":26064,"wgArticleId":3120,"wgIsArticle":!0,"wgIsRedirect":!1,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":"TOC0","wgRelevantArticleId":3120,"wgIsProbablyEditable":!1,"wgRelevantPageIsProbablyEditable":!1,"wgRestrictionEdit":[],"wgRestrictionMove":[]};RLSTATE={"site.styles":"ready","noscript":"ready","user.styles":"ready","user":"ready","user.options":
"loading","skins.vector.styles.legacy":"ready","mediawiki.toc.styles":"ready"};RLPAGEMODULES=["ext.RegularTooltips","site","mediawiki.page.startup","mediawiki.page.ready","mediawiki.toc","skins.vector.legacy.js"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@1hzgi",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});
});});</script>
<link rel="stylesheet" href="https://linux-sunxi.org/load.php?lang=en&amp;modules=mediawiki.toc.styles%7Cskins.vector.styles.legacy&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://linux-sunxi.org/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://linux-sunxi.org/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.35.8"/>
<link rel="shortcut icon" href="https://linux-sunxi.org/favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="https://linux-sunxi.org/opensearch_desc.php" title="linux-sunxi.org (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="https://linux-sunxi.org/api.php?action=rsd"/>
<link rel="license" href="http://creativecommons.org/licenses/by/3.0/"/>
<link rel="alternate" type="application/atom+xml" title="linux-sunxi.org Atom feed" href="https://linux-sunxi.org/index.php?title=Special:RecentChanges&amp;feed=atom"/>
<link rel="canonical" href="TOC0.html"/>
<!--[if lt IE 9]><script src="/resources/lib/html5shiv/html5shiv.js"></script><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-TOC0 rootpage-TOC0 skin-vector action-view skin-vector-legacy">
<div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">TOC0</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From linux-sunxi.org</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#TOC0_Header"><span class="tocnumber">1</span> <span class="toctext">TOC0 Header</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Main_Header"><span class="tocnumber">1.1</span> <span class="toctext">Main Header</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Item_Header"><span class="tocnumber">1.2</span> <span class="toctext">Item Header</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4"><a href="#TOC0_Items"><span class="tocnumber">2</span> <span class="toctext">TOC0 Items</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#Certificate_.28ID_0x010101.29"><span class="tocnumber">2.1</span> <span class="toctext">Certificate (ID 0x010101)</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Firmware_Item_.28ID_0x010202.29"><span class="tocnumber">2.2</span> <span class="toctext">Firmware Item (ID 0x010202)</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Key_Item_.28ID_0x10303.29"><span class="tocnumber">2.3</span> <span class="toctext">Key Item (ID 0x10303)</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8"><a href="#TOC0_images_generation"><span class="tocnumber">3</span> <span class="toctext">TOC0 images generation</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#U-Boot.27s_mkimage"><span class="tocnumber">3.1</span> <span class="toctext">U-Boot's mkimage</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#TOC0_generator.2Fconverter_in_Ruby_.28Deprecated_way.29"><span class="tocnumber">3.2</span> <span class="toctext">TOC0 generator/converter in Ruby (Deprecated way)</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-11"><a href="#TOC0_vs._eGON.BT0"><span class="tocnumber">4</span> <span class="toctext">TOC0 vs. eGON.BT0</span></a></li>
<li class="toclevel-1 tocsection-12"><a href="#ToDo"><span class="tocnumber">5</span> <span class="toctext">ToDo</span></a>
<ul>
<li class="toclevel-2 tocsection-13"><a href="#Check_if_it_is_actually_possible_to_configure_secure_peripherals_after_booting_via_eGON.BT0._Are_there_any_other_differences.3F"><span class="tocnumber">5.1</span> <span class="toctext">Check if it is actually possible to configure secure peripherals after booting via eGON.BT0. Are there any other differences?</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Implement_and_test_FEL_boot_for_TOC0_bootloaders."><span class="tocnumber">5.2</span> <span class="toctext">Implement and test FEL boot for TOC0 bootloaders.</span></a></li>
</ul>
</li>
</ul>
</div>

<h1><span class="mw-headline" id="TOC0_Header">TOC0 Header</span></h1>
<p>The TOC0 header is made up of a main header followed immediately by two or more item headers.
</p>
<h2><span class="mw-headline" id="Main_Header">Main Header</span></h2>
<table class="wikitable">
<tbody><tr>
<th>Name</th>
<th>Offset</th>
<th>Size</th>
<th>Values</th>
<th>Description
</th></tr>
<tr>
<td>TOC0_NAME</td>
<td>0x00</td>
<td>8B</td>
<td><pre>"TOC0.GLH"</pre></td>
<td>Name
</td></tr>
<tr>
<td>TOC0_MAGIC</td>
<td>0x08</td>
<td>4B</td>
<td><pre>0x89119800</pre></td>
<td>Magic value
</td></tr>
<tr>
<td>TOC0_CHECK_SUM</td>
<td>0x0c</td>
<td>4B</td>
<td></td>
<td>Checksum, same algorithm as eGON.BT0 images
</td></tr>
<tr>
<td>TOC0_SERIAL_NUM</td>
<td>0x10</td>
<td>4B</td>
<td></td>
<td>Possibly ignored by the SBROM
</td></tr>
<tr>
<td>TOC0_STATUS</td>
<td>0x14</td>
<td>4B</td>
<td><pre>0x0: Not encrypted
0x1: Encrypted with the SSK
0x2: Encrypted with the BSSK
</pre></td>
<td>Possibly ignored by the SBROM
</td></tr>
<tr>
<td>TOC0_NUM_ITEMS</td>
<td>0x18</td>
<td>4B</td>
<td>2+</td>
<td>Number of item headers following the main header. Since unknown item headers are ignored, this can be greater than the number of actual items to create gaps in the header.
</td></tr>
<tr>
<td>TOC0_LENGTH</td>
<td>0x1c</td>
<td>4B</td>
<td></td>
<td>Total length of the TOC0 image. This must be a multiple of the storage block size (e.g. 512B or 8KiB).
</td></tr>
<tr>
<td>TOC0_BOOT_MEDIA</td>
<td>0x20</td>
<td>4B</td>
<td></td>
<td>The first byte is the boot device, written by SBROM. The meaning of the other three bytes is unknown.
</td></tr>
<tr>
<td>TOC0_RESERVED</td>
<td>0x24</td>
<td>8B</td>
<td></td>
<td>Ignored by the SBROM
</td></tr>
<tr>
<td>TOC0_END</td>
<td>0x2c</td>
<td>4B</td>
<td><pre>"MIE;"</pre></td>
<td>End marker
</td></tr></tbody></table>
<h2><span class="mw-headline" id="Item_Header">Item Header</span></h2>
<p>The SBROM searches for items by name. This means item headers can appear in any order, and item headers with unknown IDs are ignored.
</p>
<table class="wikitable">
<tbody><tr>
<th>Name</th>
<th>Offset</th>
<th>Size</th>
<th>Values</th>
<th>Description
</th></tr>
<tr>
<td>TOC0_ITEMn_ID</td>
<td>0x30 + n * 0x20 + 0x00</td>
<td>4B</td>
<td><pre> 0x010101 = Certificate Item
 0x010202 = Firmware Item (code)
 0x010303 = Key Item (first used on H6)
</pre></td>
<td>Item ID, see descriptions below
</td></tr>
<tr>
<td>TOC0_ITEMn_OFFSET</td>
<td>0x30 + n * 0x20 + 0x04</td>
<td>4B</td>
<td></td>
<td>Item data offset from start of TOC0. For the firmware item, this should be aligned to 32 bytes.
</td></tr>
<tr>
<td>TOC0_ITEMn_LENGTH</td>
<td>0x30 + n * 0x20 + 0x08</td>
<td>4B</td>
<td></td>
<td>Item data length. For the firmware item, this should be aligned to 32 bytes.
</td></tr>
<tr>
<td>TOC0_ITEMn_STATUS</td>
<td>0x30 + n * 0x20 + 0x0c</td>
<td>4B</td>
<td><pre>0x0: Not encrypted
0x1: Encrypted
</pre></td>
<td>Possibly ignored by the SBROM
</td></tr>
<tr>
<td>TOC0_ITEMn_TYPE</td>
<td>0x30 + n * 0x20 + 0x10</td>
<td>4B</td>
<td><pre>0x0: Null
0x1: Certificate
0x2: Signed binary
0x3: Binary
</pre></td>
<td>Appears to be ignored by the SBROM
</td></tr>
<tr>
<td>TOC0_ITEMn_RUN_ADDR</td>
<td>0x30 + n * 0x20 + 0x14</td>
<td>4B</td>
<td></td>
<td>Address to copy firmware item to before running it
</td></tr>
<tr>
<td>TOC0_ITEMn_RESERVED</td>
<td>0x30 + n * 0x20 + 0x18</td>
<td>4B</td>
<td></td>
<td>Ignored by the SBROM
</td></tr>
<tr>
<td>TOC0_ITEMn_END</td>
<td>0x30 + n * 0x20 + 0x1c</td>
<td>4B</td>
<td><pre>"IIE;"</pre></td>
<td>End marker
</td></tr></tbody></table>
<h1><span class="mw-headline" id="TOC0_Items">TOC0 Items</span></h1>
<h2><span id="Certificate_(ID_0x010101)"></span><span class="mw-headline" id="Certificate_.28ID_0x010101.29">Certificate (ID 0x010101)</span></h2>
<p>This is a DER-encoded X.509-like certificate containing a SHA256 hash of the firmware item. Only a few of the certificate fields are even read, and of those, some are ignored. The certificate has a similar structure to standard X.509 certificates, but is different in many important details:
</p>
<ul><li>The public key is stored in a non-standard way.</li>
<li>The hash is added at the place of extensions, but not as a real extension.</li>
<li>The last 4 bytes of the certificate (which are the last 4 bytes of the firmware digest) are not signed.</li>
<li>The signature algorithm is prepended to the signature, but the two objects are not inside a sequence.</li></ul>
<p>Below is the structure of the minimal certificate that is accepted by the SBROM:
</p>
<pre>    0:d=0  hl=4 l= 601 cons: SEQUENCE          #
    4:d=1  hl=4 l= 330 cons:  SEQUENCE         #
    8:d=2  hl=2 l=   3 cons:   cont [ 0 ]      #
   10:d=3  hl=2 l=   1 prim:    INTEGER        # "version"      -- Up to 4 bytes are read (but ignored); contents must be exactly 2 bytes into the sequence
   13:d=2  hl=2 l=   1 prim:   INTEGER         # "serialNumber" -- Up to 4 bytes are read (but ignored)
   16:d=2  hl=2 l=   0 cons:   SEQUENCE        # "signature"    -- Up to 255 bytes are read (but ignored)
   18:d=2  hl=2 l=   0 cons:   SEQUENCE        # "issuer"       -- The tag must be 0x30 (SEQUENCE), but the data is not read
   20:d=2  hl=2 l=   0 cons:   SEQUENCE        # "validity"     -- The tag must be 0x30 (SEQUENCE), but the data is not read
   22:d=2  hl=2 l=   0 cons:   SEQUENCE        # "subject"      -- The tag must be 0x30 (SEQUENCE), but the data is not read
   24:d=2  hl=4 l= 272 cons:   SEQUENCE        # "subjectPublicKeyInfo"
   28:d=3  hl=2 l=   0 cons:    SEQUENCE       # "algorithm"    -- Up to 255 bytes are read (but ignored); contents must follow exactly 6 bytes after "subject"
   30:d=3  hl=4 l= 266 cons:    SEQUENCE       #
   34:d=4  hl=4 l= 257 prim:     INTEGER       # Public key "n" -- Up to 400 bytes are read
  295:d=4  hl=2 l=   3 prim:     INTEGER       # Public key "e" -- Up to 400 bytes are read
  300:d=2  hl=2 l=  36 cons:   cont [ 3 ]      #
  302:d=3  hl=2 l=  34 cons:    SEQUENCE       #
  304:d=4  hl=2 l=  32 prim:     OCTET STRING  # Firmware hash  -- Contents must follow exactly 6 bytes after the key exponent
  338:d=1  hl=4 l= 263 cons:  SEQUENCE         #                -- The tag must be 0x03 (BIT STRING), but this is really a sequence
  342:d=2  hl=2 l=   0 cons:   SEQUENCE        #                -- The tag must be 0x30 (SEQUENCE)
  344:d=2  hl=4 l= 257 prim:   BIT STRING      # RSA signature  -- Up to 400 bytes are read
</pre>
<p>When the SBROM reads a 256-byte or longer object such as the public key modulus or signature (i.e. when the first length byte is 0x82), if the length is odd, the first byte is ignored. This means a modulus with the high bit set can either be encoded as a negative INTEGER, or zero-extended to 257 bytes to remain positive. Both encodings are accepted. Similarly, the "bits remaining" field at the beginning of the inner signature BIT STRING is ignored. This does <i>not</i> apply to the outer signature (fake) "BIT STRING", which must not have a "bits remaining" field at all.
</p><p>If the SBROM is configured to use a key item (this is the default on the H6; it is unavailable on older SoCs), the certificate must include (and be signed by) "KEY1" from the key item. Otherwise, it must include (and be signed by) the ROTPK. To make a TOC0 that will be accepted either way, fill both slots in the key item with the ROTPK.
</p><p>If a <a href="SID_Register_Guide.html#ROTPK_HASH" title="SID Register Guide">ROTPK_HASH</a> is programmed, only certificates (or key items) with that key are accepted. Otherwise, any key you generate can be the ROTPK.
</p><p>Certificates generated by the BSP do not use padding when computing the signature. However, because the SBROM only looks at the least-significant 32 bytes of the decrypted signature, any padding algorithm can be used.
</p><p>While the SBROM will read and parse a certificate containing 3072-bit RSA keys, it is hardcoded to perform 2048-bit modular arithmetic, so such a certificate will fail to verify.
</p>
<h2><span id="Firmware_Item_(ID_0x010202)"></span><span class="mw-headline" id="Firmware_Item_.28ID_0x010202.29">Firmware Item (ID 0x010202)</span></h2>
<p>This item has no specific format. After verifying against the SHA256 hash in the certificate, this item is memmove'd to the run address given in the item header and executed in secure mode. This run address can be anywhere in SRAM, except where it would overwrite the SBROM's stack. Note that the memmove happens after the SBROM stores the boot device in the main header, so if the run address is in the first 0x24 bytes of SRAM A1, that information will be lost.
</p><p>The only format requirement is that the item, as stored in the TOC0 image, must start and end on a 32-byte boundary. This requirement comes from the SHA256 implementation, which expects full, aligned blocks.
</p>
<h2><span id="Key_Item_(ID_0x10303)"></span><span class="mw-headline" id="Key_Item_.28ID_0x10303.29">Key Item (ID 0x10303)</span></h2>
<p>This item links two public keys together. It is signed by the first key. If the <a href="SID_Register_Guide.html#H6" title="SID Register Guide">VENDOR_ID</a> eFUSE is programmed, the VENDOR_ID value in the key item is checked against it.
</p><p>The key item has the following format:
</p>
<table class="wikitable">
<tbody><tr>
<th>Name</th>
<th>Offset</th>
<th>Size</th>
<th>Description
</th></tr>
<tr>
<td>VENDOR_ID</td>
<td>0x000</td>
<td>4B</td>
<td>Arbitrary identifier, must match eFUSE value if programmed
</td></tr>
<tr>
<td>KEY0_N_LEN</td>
<td>0x004</td>
<td>4B</td>
<td>Length of KEY0 modulus, in bytes. In practice, only 2048-bit keys are supported.
</td></tr>
<tr>
<td>KEY0_E_LEN</td>
<td>0x008</td>
<td>4B</td>
<td>Length of KEY0 exponent, in bytes
</td></tr>
<tr>
<td>KEY1_N_LEN</td>
<td>0x00c</td>
<td>4B</td>
<td>Length of KEY1 modulus, in bytes. In practice, only 2048-bit keys are supported.
</td></tr>
<tr>
<td>KEY1_E_LEN</td>
<td>0x010</td>
<td>4B</td>
<td>Length of KEY1 exponent, in bytes
</td></tr>
<tr>
<td>SIG_LEN</td>
<td>0x014</td>
<td>4B</td>
<td>Length of signature (signed by KEY0), in bytes. In practice, only 2048-bit signatures are supported.
</td></tr>
<tr>
<td>KEY0</td>
<td>0x018</td>
<td>512B</td>
<td>KEY0 modulus, followed by KEY0 exponent
</td></tr>
<tr>
<td>KEY1</td>
<td>0x218</td>
<td>512B</td>
<td>KEY1 modulus, followed by KEY1 exponent
</td></tr>
<tr>
<td>RESERVED</td>
<td>0x418</td>
<td>32B</td>
<td>Ignored
</td></tr>
<tr>
<td>SIGNATURE</td>
<td>0x438</td>
<td>...</td>
<td>SHA256+RSA signature of all other fields
</td></tr></tbody></table>
<h1><span class="mw-headline" id="TOC0_images_generation">TOC0 images generation</span></h1>
<h2><span id="U-Boot's_mkimage"></span><span class="mw-headline" id="U-Boot.27s_mkimage">U-Boot's mkimage</span></h2>
<p>Since U-Boot v2022.07 the mkimage tool supports the TOC0 format. To generate a TOC0 image from a binary, you will need an RSA key (pair) file. As most secure-boot enabled devices do not burn the VENDOR_ID eFUSE, you can use any RSA key, so just generate one, for instance with the openssl tool (would only need to be done once):
</p>
<pre>   openssl genrsa -out root_key.pem
   mkimage -A arm -T sunxi_toc0 -a 0x20000 -d input.bin output.toc0
</pre>
<p>The TOC0 format requires a fixed load address, so the generated image file will only work on devices where this address is located in some SRAM.
</p><p>When building a U-Boot image, setting CONFIG_SPL_IMAGE_TYPE_SUNXI_TOC0=y will automatically generate a TOC0 SPL (with the right load address) and will integrate this with U-Boot proper as usual.
</p>
<h2><span id="TOC0_generator/converter_in_Ruby_(Deprecated_way)"></span><span class="mw-headline" id="TOC0_generator.2Fconverter_in_Ruby_.28Deprecated_way.29">TOC0 generator/converter in Ruby (Deprecated way)</span></h2>
<p>There is a preliminary script: <a class="external free" href="https://gist.github.com/jemk/2abcab1359c4bce793679c5854062331">https://gist.github.com/jemk/2abcab1359c4bce793679c5854062331</a>
</p><p>Some notes:
</p>
<ul><li>You may need to replace the ".sum" method with ".reduce(:+)" to run it with modern versions of Ruby</li>
<li>You may need to change the entry point address from 0x0 to 0x10000 if you want to run it on A64/H64/H5 (the default 0x0 value is used for H3)</li></ul>
<p>The experimental branch <a class="external free" href="https://github.com/ssvb/sunxi-tools/commits/toc0">https://github.com/ssvb/sunxi-tools/commits/toc0</a> contains two scripts (<a class="external text" href="https://github.com/ssvb/sunxi-tools/blob/toc0/egon2toc.rb">egon2toc.rb</a> and <a class="external text" href="https://github.com/ssvb/sunxi-tools/blob/toc0/toc2egon.rb">toc2egon.rb</a>, based on Jemk's library). They can be used to convert SPL binaries back and forth between these two formats. Usage example:
</p>
<pre>   git clone -b toc0 <a class="external free" href="https://github.com/ssvb/sunxi-tools.git">https://github.com/ssvb/sunxi-tools.git</a>
   cd sunxi-tools
   ruby egon2toc.rb bin/uart0-helloworld-sdboot.sunxi bin/uart0-helloworld-sdboot.toc0
   ruby toc2egon.rb bin/uart0-helloworld-sdboot.toc0 roundtrip-conversion-output.sunxi
   cmp -b bin/uart0-helloworld-sdboot.sunxi roundtrip-conversion-output.sunxi
</pre>
<p>The resulting file <b>bin/uart0-helloworld-sdboot.toc0</b> can be written to an SD card or to SPI NOR flash and successfully booted on Allwinner H3/A64/H64 devices with secure mode bit burned in the eFUSE.
</p><p>Doing conversion of the <b>u-boot-sunxi-with-spl.bin</b> files (not just SPL alone) back and forth between eGON and TOC0 formats requires a minor patch for U-Boot.
</p>
<h1><span class="mw-headline" id="TOC0_vs._eGON.BT0">TOC0 vs. eGON.BT0</span></h1>
<table class="wikitable">
<tbody><tr>
<th rowspan="2">Feature
</th>
<th colspan="2">Allwinner A64/H64/H5
</th></tr>
<tr>
<th>eGON.BT0
</th>
<th>TOC0
</th></tr>
<tr>
<td>Boot time</td>
<td><a rel="nofollow" class="external text" href="https://irclog.whitequark.org/linux-sunxi/2017-02-28#18947983;#18947983;">TBD</a></td>
<td>TBD (but worse than eGON)
</td></tr>
<tr>
<td>SPL size limit</td>
<td>32 KiB (SRAM A1), H6 and newer chips may support larger</td>
<td>more than 100 KiB (SRAM A1 + SRAM C)
</td></tr>
<tr>
<td>SPL load address</td>
<td>Loaded into SRAM A1 and executed there. This address is may be different on different SoC types, but the same position independent code can run on multiple SoC types (see <a class="external text" href="https://github.com/linux-sunxi/sunxi-tools/blob/master/uart0-helloworld-sdboot.c">uart0-helloworld-sdboot</a> example)</td>
<td>The load &amp; execute address is specified in the TOC0 item header and it should be set as SRAM A1 address of the SoC (or at least land into a valid SRAM address range). This is a little bit problematic, because it becomes difficult to boot the same image, for example, on H3 and A64 (but maybe we can load the SPL into SRAM A2 to overcome this?).
</td></tr>
<tr>
<td>Can boot from</td>
<td>Works with SD card, eMMC, eMMC boot partitions, SPI. NAND is untested.</td>
<td>Works with SD card, eMMC, eMMC boot partitions. SPI and NAND are still untested.
</td></tr>
<tr>
<td>Boot source detection</td>
<td>A 8-bit boot media type identifier is written by the BROM at the offset 0x28 in SRAM A1</td>
<td>A 8-bit boot media type identifier is written by the BROM at the offset 0x20 in SRAM A1
</td></tr>
<tr>
<td>Secure peripherals</td>
<td>Access to SID and the other secure-only resources is allowed from both secure and non-secure mode, SPC settings are ignored. Investigation for a possible fix or workaround is underway.</td>
<td>Work correctly, SPC settings are respected.<br /><br /><b>Note:</b> some peripherals are switchable but the others are secure-only (such as SID). It means that secure boot is not a superset and the eGON-style non-secure boot configuration can't be replicated at the moment. This may cause inconveniences for the Linux kernel (reading SID is a perfect example) and some assistance from the firmware will be required.
</td></tr></tbody></table>
<p>The currently used eGON.BT0 images can be wrapped into TOC0 containers with just a little bit of adaptation. As discussed in the irc log, a small extra stub code added to the TOC0 container can ensure that the eGON.BT0 image lands at the start of SRAM A1 and also the boot media identifier can be patched there at the expected offset 0x28. This way the differences between eGON.BT0 and TOC0 can be fully hidden and we can continue using eGON.BT0 as a single unified format for the SPL on Allwinner devices (the 32K size restriction can be lifted though).
</p><p>The task of converting from eGON.BT0 to TOC0 can be delegated to a smart flasher tool. For example, sunxi-fel can check whether the secure boot bit is set in <a rel="nofollow" class="external text" href="SID_Register_Guide.html#LCJS">LCJS</a> and automatically do conversion into the TOC0 format <a rel="nofollow" class="external text" href="Bootable_SPI_flash.html#Using_the_sunxi-fel_tool">when flashing SPI NOR</a>. As an additional safety measure, it's also best if the tool can verify that the device is not locked down to only accept some particular key.
</p><p>U-Boot build may produce images in both formats, but a smart flasher tool can interchangeably use either of them if the conversion is straightforward (this way a possible user error is eliminated).
</p><p>This all is very similar in principle to what we have already done with FEL USB boot support (eliminate a special extra U-Boot build configuration and just use a single unified image for both SD card boot and FEL USB boot): <a rel="nofollow" class="external free" href="https://lists.denx.de/pipermail/u-boot/2015-February/204388.html">https://lists.denx.de/pipermail/u-boot/2015-February/204388.html</a>
</p><p>U-Boot build generates a single unified <a class="external text" href="https://en.wikipedia.org/wiki/Nuclear_weapon">"payload"</a>. And sunxi-tools provides a suitable <a class="external text" href="https://en.wikipedia.org/wiki/Nuclear_weapons_delivery">"delivery"</a> method&#160;:-)
</p>
<h1><span class="mw-headline" id="ToDo">ToDo</span></h1>
<h2><span id="Check_if_it_is_actually_possible_to_configure_secure_peripherals_after_booting_via_eGON.BT0._Are_there_any_other_differences?"></span><span class="mw-headline" id="Check_if_it_is_actually_possible_to_configure_secure_peripherals_after_booting_via_eGON.BT0._Are_there_any_other_differences.3F">Check if it is actually possible to configure secure peripherals after booting via eGON.BT0. Are there any other differences?</span></h2>
<p>Tried to dump and compare HW registers with/without TOC0: <a class="external free" href="https://gist.github.com/ssvb/88963c61c714068716412d828b9ff74e/revisions">https://gist.github.com/ssvb/88963c61c714068716412d828b9ff74e/revisions</a>
</p><p>There was a hope to maybe find some magic bit, which will allow restricting access to peripherals in non-secure mode.
</p><p>This is a trivial quick and dirty test program, which can verify if such restrictions actually work as expected: <a class="external free" href="https://github.com/ssvb/sunxi-tools/commit/3ffc4fbc3e5448d3390052ad2aa553afe69fefe6">https://github.com/ssvb/sunxi-tools/commit/3ffc4fbc3e5448d3390052ad2aa553afe69fefe6</a>
</p><p>Running it on <a href="Jide_Remix_Mini.html" title="Jide Remix Mini">Jide Remix Mini</a> (secure bit is set in eFUSE) via "sunxi-fel spl" after "sunxi-fel smc":
</p>
<pre>Checking the current mode ... secure.
Switching to non-secure ... done.
Checking peripherals security ... SRAM A2 is not accessible (this is GOOD).

Hello from Allwinner A64!
Returning back to FEL.
</pre>
<p>Running on <a href="Pine64.html" title="Pine64">Pine64</a> (secure bit is not set in eFUSE) via "sunxi-fel spl":
</p>
<pre>Checking the current mode ... secure.
Switching to non-secure ... done.
Checking peripherals security ... SRAM A2 is accessible (this is BAD).

Hello from Allwinner A64!
Returning back to FEL.
</pre>
<p>None of the attempts to toggle various bits in various HW registers helped so far on Pine64, restricting access to SRAM A2 does not work.
</p><p>Note: the test program does not work correctly on Jide Remix Mini when booting from SD card (deadlocks when trying to switch to non-secure, most likely the default settings are not the same as in FEL mode):
</p>
<pre>Checking the current mode ... secure.
Switching to non-secure ... 
</pre>
<h2><span class="mw-headline" id="Implement_and_test_FEL_boot_for_TOC0_bootloaders.">Implement and test <a href="FEL/USBBoot.html" title="FEL/USBBoot">FEL boot</a> for TOC0 bootloaders.</span></h2>
<p>We can in principle boot TOC0 images via sunxi-fel even on boards without the secure bit set in eFUSE (and can boot oversized TOC0 images too). This just needs to be implemented.
</p>
<!-- 
NewPP limit report
Cached time: 20251029184915
Cache expiry: 86400
Dynamic content: false
Complications: []
CPU time usage: 0.053 seconds
Real time usage: 0.073 seconds
Preprocessor visited node count: 105/1000000
Post‐expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 2801/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.000      1 -total
-->

<!-- Saved in parser cache with key wiki:pcache:idhash:3120-0!canonical and timestamp 20251029184915 and revision id 26064
 -->
</div></div><div class="printfooter">Retrieved from "<a dir="ltr" href="https://linux-sunxi.org/index.php?title=TOC0&amp;oldid=26064">https://linux-sunxi.org/index.php?title=TOC0&amp;oldid=26064</a>"</div>
		<div id="catlinks" class="catlinks catlinks-allhidden" data-mw="interface"></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-personal" class="vector-menu" aria-labelledby="p-personal-label" role="navigation" 
	 >
	<h3 id="p-personal-label">
		<span>Personal tools</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="pt-createaccount"><a href="https://linux-sunxi.org/index.php?title=Special:CreateAccount&amp;returnto=TOC0" title="You are encouraged to create an account and log in; however, it is not mandatory">Create account</a></li><li id="pt-login"><a href="https://linux-sunxi.org/index.php?title=Special:UserLogin&amp;returnto=TOC0" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li></ul>
		
	</div>
</nav>


		<div id="left-navigation">
			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-namespaces" class="vector-menu vector-menu-tabs vectorTabs" aria-labelledby="p-namespaces-label" role="navigation" 
	 >
	<h3 id="p-namespaces-label">
		<span>Namespaces</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected"><a href="TOC0.html" title="View the content page [c]" accesskey="c">Page</a></li><li id="ca-talk" class="new"><a href="https://linux-sunxi.org/index.php?title=Talk:TOC0&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t">Discussion</a></li></ul>
		
	</div>
</nav>


			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-variants" class="vector-menu-empty emptyPortlet vector-menu vector-menu-dropdown vectorMenu" aria-labelledby="p-variants-label" role="navigation" 
	 >
	<input type="checkbox" class="vector-menu-checkbox vectorMenuCheckbox" aria-labelledby="p-variants-label" />
	<h3 id="p-variants-label">
		<span>Variants</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="menu vector-menu-content-list"></ul>
		
	</div>
</nav>


		</div>
		<div id="right-navigation">
			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-views" class="vector-menu vector-menu-tabs vectorTabs" aria-labelledby="p-views-label" role="navigation" 
	 >
	<h3 id="p-views-label">
		<span>Views</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="ca-view" class="collapsible selected"><a href="TOC0.html">Read</a></li><li id="ca-viewsource" class="collapsible"><a href="https://linux-sunxi.org/index.php?title=TOC0&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li><li id="ca-history" class="collapsible"><a href="https://linux-sunxi.org/index.php?title=TOC0&amp;action=history" title="Past revisions of this page [h]" accesskey="h">View history</a></li></ul>
		
	</div>
</nav>


			<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-cactions" class="vector-menu-empty emptyPortlet vector-menu vector-menu-dropdown vectorMenu" aria-labelledby="p-cactions-label" role="navigation" 
	 >
	<input type="checkbox" class="vector-menu-checkbox vectorMenuCheckbox" aria-labelledby="p-cactions-label" />
	<h3 id="p-cactions-label">
		<span>More</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="menu vector-menu-content-list"></ul>
		
	</div>
</nav>


			<div id="p-search" role="search">
	<h3 >
		<label for="searchInput">Search</label>
	</h3>
	<form action="https://linux-sunxi.org/index.php" id="searchform">
		<div id="simpleSearch">
			<input type="search" name="search" placeholder="Search linux-sunxi.org" title="Search linux-sunxi.org [f]" accesskey="f" id="searchInput"/>
			<input type="hidden" name="title" value="Special:Search">
			<input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton"/>
			<input type="submit" name="go" value="Go" title="Go to a page with this exact name if it exists" id="searchButton" class="searchButton"/>
		</div>
	</form>
</div>

		</div>
	</div>
	
<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a  title="Visit the main page" class="mw-wiki-logo" href="Main_Page.html"></a>
	</div>
	<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-navigation" class="vector-menu vector-menu-portal portal portal-first" aria-labelledby="p-navigation-label" role="navigation" 
	 >
	<h3 id="p-navigation-label">
		<span>Navigation</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="n-mainpage-description"><a href="Main_Page.html" title="Visit the main page [z]" accesskey="z">Main page</a></li><li id="n-portal"><a href="sunxi:Community_portal.html" title="About the project, what you can do, where to find things">Community portal</a></li><li id="n-recentchanges"><a href="https://linux-sunxi.org/Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li><li id="n-randompage"><a href="https://linux-sunxi.org/Special:Random" title="Load a random page [x]" accesskey="x">Random page</a></li><li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" rel="nofollow" title="The place to find out">Help</a></li></ul>
		
	</div>
</nav>


	<!-- Please do not use role attribute as CSS selector, it is deprecated. -->
<nav id="p-tb" class="vector-menu vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation" 
	 >
	<h3 id="p-tb-label">
		<span>Tools</span>
	</h3>
	<!-- Please do not use the .body class, it is deprecated. -->
	<div class="body vector-menu-content">
		<!-- Please do not use the .menu class, it is deprecated. -->
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere"><a href="https://linux-sunxi.org/Special:WhatLinksHere/TOC0" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="https://linux-sunxi.org/Special:RecentChangesLinked/TOC0" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li><li id="t-specialpages"><a href="https://linux-sunxi.org/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="javascript:print();" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="https://linux-sunxi.org/index.php?title=TOC0&amp;oldid=26064" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="https://linux-sunxi.org/index.php?title=TOC0&amp;action=info" title="More information about this page">Page information</a></li></ul>
		
	</div>
</nav>


	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo" >
	<ul id="footer-info" >
		<li id="footer-info-lastmod"> This page was last edited on 8 November 2024, at 23:30.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution</a> unless otherwise noted.</li>
	</ul>
	<ul id="footer-places" >
		<li id="footer-places-privacy"><a href="https://linux-sunxi.org/sunxi:Privacy_policy" title="sunxi:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="https://linux-sunxi.org/sunxi:About" title="sunxi:About">About linux-sunxi.org</a></li>
		<li id="footer-places-disclaimer"><a href="https://linux-sunxi.org/sunxi:General_disclaimer" title="sunxi:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico"><a href="http://creativecommons.org/licenses/by/3.0/"><img src="https://linux-sunxi.org/resources/assets/licenses/cc-by.png" alt="Creative Commons Attribution" width="88" height="31" loading="lazy"/></a></li>
		<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="https://linux-sunxi.org/resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="https://linux-sunxi.org/resources/assets/poweredby_mediawiki_132x47.png 1.5x, https://linux-sunxi.org/resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"/></a></li>
	</ul>
	<div style="clear: both;"></div>
</footer>



<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.053","walltime":"0.073","ppvisitednodes":{"value":105,"limit":1000000},"postexpandincludesize":{"value":0,"limit":2097152},"templateargumentsize":{"value":0,"limit":2097152},"expansiondepth":{"value":2,"limit":40},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":2801,"limit":5000000},"timingprofile":["100.00%    0.000      1 -total"]},"cachereport":{"timestamp":"20251029184915","ttl":86400,"transientcontent":false}}});});</script>
<!-- No web analytics configured. -->

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":214});});</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"016cbc9bb6a94e94934580b61e921a02","server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body></html>
